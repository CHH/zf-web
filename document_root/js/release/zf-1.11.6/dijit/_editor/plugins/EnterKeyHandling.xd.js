/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dijit._editor.plugins.EnterKeyHandling"],["require","dijit._base.scroll"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dijit._editor.plugins.EnterKeyHandling"]){_4._hasResource["dijit._editor.plugins.EnterKeyHandling"]=true;_4.provide("dijit._editor.plugins.EnterKeyHandling");_4.require("dijit._base.scroll");_4.declare("dijit._editor.plugins.EnterKeyHandling",_5._editor._Plugin,{blockNodeForEnter:"BR",constructor:function(_7){if(_7){_4.mixin(this,_7);}},setEditor:function(_8){this.editor=_8;if(this.blockNodeForEnter=="BR"){if(_4.isIE){_8.contentDomPreFilters.push(_4.hitch(this,"regularPsToSingleLinePs"));_8.contentDomPostFilters.push(_4.hitch(this,"singleLinePsToRegularPs"));_8.onLoadDeferred.addCallback(_4.hitch(this,"_fixNewLineBehaviorForIE"));}else{_8.onLoadDeferred.addCallback(_4.hitch(this,function(d){try{this.editor.document.execCommand("insertBrOnReturn",false,true);}catch(e){}return d;}));}}else{if(this.blockNodeForEnter){_4["require"]("dijit._editor.range");var h=_4.hitch(this,this.handleEnterKey);_8.addKeyHandler(13,0,0,h);_8.addKeyHandler(13,0,1,h);this.connect(this.editor,"onKeyPressed","onKeyPressed");}}},onKeyPressed:function(e){if(this._checkListLater){if(_4.withGlobal(this.editor.window,"isCollapsed",_5)){var _9=_4.withGlobal(this.editor.window,"getAncestorElement",_5._editor.selection,["LI"]);if(!_9){_5._editor.RichText.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);var _a=_4.withGlobal(this.editor.window,"getAncestorElement",_5._editor.selection,[this.blockNodeForEnter]);if(_a){_a.innerHTML=this.bogusHtmlContent;if(_4.isIE){var r=this.editor.document.selection.createRange();r.move("character",-1);r.select();}}else{console.error("onKeyPressed: Cannot find the new block node");}}else{if(_4.isMoz){if(_9.parentNode.parentNode.nodeName=="LI"){_9=_9.parentNode.parentNode;}}var fc=_9.firstChild;if(fc&&fc.nodeType==1&&(fc.nodeName=="UL"||fc.nodeName=="OL")){_9.insertBefore(fc.ownerDocument.createTextNode(" "),fc);var _b=_5.range.create(this.editor.window);_b.setStart(_9.firstChild,0);var _c=_5.range.getSelection(this.editor.window,true);_c.removeAllRanges();_c.addRange(_b);}}}this._checkListLater=false;}if(this._pressedEnterInBlock){if(this._pressedEnterInBlock.previousSibling){this.removeTrailingBr(this._pressedEnterInBlock.previousSibling);}delete this._pressedEnterInBlock;}},bogusHtmlContent:"&nbsp;",blockNodes:/^(?:P|H1|H2|H3|H4|H5|H6|LI)$/,handleEnterKey:function(e){var _d,_e,_f,doc=this.editor.document,br;if(e.shiftKey){var _10=_4.withGlobal(this.editor.window,"getParentElement",_5._editor.selection);var _11=_5.range.getAncestor(_10,this.blockNodes);if(_11){if(!e.shiftKey&&_11.tagName=="LI"){return true;}_d=_5.range.getSelection(this.editor.window);_e=_d.getRangeAt(0);if(!_e.collapsed){_e.deleteContents();_d=_5.range.getSelection(this.editor.window);_e=_d.getRangeAt(0);}if(_5.range.atBeginningOfContainer(_11,_e.startContainer,_e.startOffset)){if(e.shiftKey){br=doc.createElement("br");_f=_5.range.create(this.editor.window);_11.insertBefore(br,_11.firstChild);_f.setStartBefore(br.nextSibling);_d.removeAllRanges();_d.addRange(_f);}else{_4.place(br,_11,"before");}}else{if(_5.range.atEndOfContainer(_11,_e.startContainer,_e.startOffset)){_f=_5.range.create(this.editor.window);br=doc.createElement("br");if(e.shiftKey){_11.appendChild(br);_11.appendChild(doc.createTextNode(" "));_f.setStart(_11.lastChild,0);}else{_4.place(br,_11,"after");_f.setStartAfter(_11);}_d.removeAllRanges();_d.addRange(_f);}else{return true;}}}else{_5._editor.RichText.prototype.execCommand.call(this.editor,"inserthtml","<br>");}return false;}var _12=true;_d=_5.range.getSelection(this.editor.window);_e=_d.getRangeAt(0);if(!_e.collapsed){_e.deleteContents();_d=_5.range.getSelection(this.editor.window);_e=_d.getRangeAt(0);}var _13=_5.range.getBlockAncestor(_e.endContainer,null,this.editor.editNode);var _14=_13.blockNode;if((this._checkListLater=(_14&&(_14.nodeName=="LI"||_14.parentNode.nodeName=="LI")))){if(_4.isMoz){this._pressedEnterInBlock=_14;}if(/^(\s|&nbsp;|\xA0|<span\b[^>]*\bclass=['"]Apple-style-span['"][^>]*>(\s|&nbsp;|\xA0)<\/span>)?(<br>)?$/.test(_14.innerHTML)){_14.innerHTML="";if(_4.isWebKit){_f=_5.range.create(this.editor.window);_f.setStart(_14,0);_d.removeAllRanges();_d.addRange(_f);}this._checkListLater=false;}return true;}if(!_13.blockNode||_13.blockNode===this.editor.editNode){try{_5._editor.RichText.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);}catch(e2){}_13={blockNode:_4.withGlobal(this.editor.window,"getAncestorElement",_5._editor.selection,[this.blockNodeForEnter]),blockContainer:this.editor.editNode};if(_13.blockNode){if(_13.blockNode!=this.editor.editNode&&(!(_13.blockNode.textContent||_13.blockNode.innerHTML).replace(/^\s+|\s+$/g,"").length)){this.removeTrailingBr(_13.blockNode);return false;}}else{_13.blockNode=this.editor.editNode;}_d=_5.range.getSelection(this.editor.window);_e=_d.getRangeAt(0);}var _15=doc.createElement(this.blockNodeForEnter);_15.innerHTML=this.bogusHtmlContent;this.removeTrailingBr(_13.blockNode);if(_5.range.atEndOfContainer(_13.blockNode,_e.endContainer,_e.endOffset)){if(_13.blockNode===_13.blockContainer){_13.blockNode.appendChild(_15);}else{_4.place(_15,_13.blockNode,"after");}_12=false;_f=_5.range.create(this.editor.window);_f.setStart(_15,0);_d.removeAllRanges();_d.addRange(_f);if(this.editor.height){_5.scrollIntoView(_15);}}else{if(_5.range.atBeginningOfContainer(_13.blockNode,_e.startContainer,_e.startOffset)){_4.place(_15,_13.blockNode,_13.blockNode===_13.blockContainer?"first":"before");if(_15.nextSibling&&this.editor.height){_f=_5.range.create(this.editor.window);_f.setStart(_15.nextSibling,0);_d.removeAllRanges();_d.addRange(_f);_5.scrollIntoView(_15.nextSibling);}_12=false;}else{if(_4.isMoz){this._pressedEnterInBlock=_13.blockNode;}}}return _12;},removeTrailingBr:function(_16){var _17=/P|DIV|LI/i.test(_16.tagName)?_16:_5._editor.selection.getParentOfType(_16,["P","DIV","LI"]);if(!_17){return;}if(_17.lastChild){if((_17.childNodes.length>1&&_17.lastChild.nodeType==3&&/^[\s\xAD]*$/.test(_17.lastChild.nodeValue))||_17.lastChild.tagName=="BR"){_4.destroy(_17.lastChild);}}if(!_17.childNodes.length){_17.innerHTML=this.bogusHtmlContent;}},_fixNewLineBehaviorForIE:function(d){var doc=this.editor.document;if(doc.__INSERTED_EDITIOR_NEWLINE_CSS===undefined){var _18=_4.create("style",{type:"text/css"},doc.getElementsByTagName("head")[0]);_18.styleSheet.cssText="p{margin:0;}";this.editor.document.__INSERTED_EDITIOR_NEWLINE_CSS=true;}return d;},regularPsToSingleLinePs:function(_19,_1a){function _1b(el){function _1c(_1d){var _1e=_1d[0].ownerDocument.createElement("p");_1d[0].parentNode.insertBefore(_1e,_1d[0]);_4.forEach(_1d,function(_1f){_1e.appendChild(_1f);});};var _20=0;var _21=[];var _22;while(_20<el.childNodes.length){_22=el.childNodes[_20];if(_22.nodeType==3||(_22.nodeType==1&&_22.nodeName!="BR"&&_4.style(_22,"display")!="block")){_21.push(_22);}else{var _23=_22.nextSibling;if(_21.length){_1c(_21);_20=(_20+1)-_21.length;if(_22.nodeName=="BR"){_4.destroy(_22);}}_21=[];}_20++;}if(_21.length){_1c(_21);}};function _24(el){var _25=null;var _26=[];var _27=el.childNodes.length-1;for(var i=_27;i>=0;i--){_25=el.childNodes[i];if(_25.nodeName=="BR"){var _28=_25.ownerDocument.createElement("p");_4.place(_28,el,"after");if(_26.length==0&&i!=_27){_28.innerHTML="&nbsp;";}_4.forEach(_26,function(_29){_28.appendChild(_29);});_4.destroy(_25);_26=[];}else{_26.unshift(_25);}}};var _2a=[];var ps=_19.getElementsByTagName("p");_4.forEach(ps,function(p){_2a.push(p);});_4.forEach(_2a,function(p){var _2b=p.previousSibling;if((_2b)&&(_2b.nodeType==1)&&(_2b.nodeName=="P"||_4.style(_2b,"display")!="block")){var _2c=p.parentNode.insertBefore(this.document.createElement("p"),p);_2c.innerHTML=_1a?"":"&nbsp;";}_24(p);},this.editor);_1b(_19);return _19;},singleLinePsToRegularPs:function(_2d){function _2e(_2f){var ps=_2f.getElementsByTagName("p");var _30=[];for(var i=0;i<ps.length;i++){var p=ps[i];var _31=false;for(var k=0;k<_30.length;k++){if(_30[k]===p.parentNode){_31=true;break;}}if(!_31){_30.push(p.parentNode);}}return _30;};function _32(_33){return (!_33.childNodes.length||_33.innerHTML=="&nbsp;");};var _34=_2e(_2d);for(var i=0;i<_34.length;i++){var _35=_34[i];var _36=null;var _37=_35.firstChild;var _38=null;while(_37){if(_37.nodeType!=1||_37.tagName!="P"||(_37.getAttributeNode("style")||{}).specified){_36=null;}else{if(_32(_37)){_38=_37;_36=null;}else{if(_36==null){_36=_37;}else{if((!_36.lastChild||_36.lastChild.nodeName!="BR")&&(_37.firstChild)&&(_37.firstChild.nodeName!="BR")){_36.appendChild(this.editor.document.createElement("br"));}while(_37.firstChild){_36.appendChild(_37.firstChild);}_38=_37;}}}_37=_37.nextSibling;if(_38){_4.destroy(_38);_38=null;}}}return _2d;}});}}};});