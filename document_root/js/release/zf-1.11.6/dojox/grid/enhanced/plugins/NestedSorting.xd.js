/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.grid.enhanced.plugins.NestedSorting"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.grid.enhanced.plugins.NestedSorting"]){_4._hasResource["dojox.grid.enhanced.plugins.NestedSorting"]=true;_4.provide("dojox.grid.enhanced.plugins.NestedSorting");_4.declare("dojox.grid.enhanced.plugins.NestedSorting",null,{sortAttrs:[],_unarySortCell:{},_minColWidth:63,_widthDelta:23,_minColWidthUpdated:false,_sortTipMap:{},_overResizeWidth:3,storeItemSelected:"storeItemSelectedAttr",exceptionalSelectedItems:[],_a11yText:{"dojoxGridDescending":"&#9662;","dojoxGridAscending":"&#9652;","dojoxGridAscendingTip":"&#1784;","dojoxGridDescendingTip":"&#1783;","dojoxGridUnsortedTip":"x"},constructor:function(_7){_7.mixin(_7,this);_4.forEach(_7.views.views,function(_8){_4.connect(_8,"renderHeader",_4.hitch(_8,_7._initSelectCols));_4.connect(_8.header,"domousemove",_8.grid,"_sychronizeResize");});_7.getSortProps=_7._getDsSortAttrs;_4.connect(_7,"_onFetchComplete",_7,"updateNewRowSelection");if(_7.indirectSelection&&_7.rowSelectCell.toggleAllSelection){_4.connect(_7.rowSelectCell,"toggleAllSelection",_7,"allSelectionToggled");}_4.subscribe(_7.rowSelectionChangedTopic,_7,_7._selectionChanged);_7.focus.destroy();_7.focus=new _6.grid.enhanced.plugins._NestedSortingFocusManager(_7);_4.connect(_7.views,"render",_7,"initAriaInfo");},setSortIndex:function(_9,_a,e){if(!this.nestedSorting){this.inherited(arguments);}else{if(this.dnd&&!this.dndRowConn){this.dndRowConn=_4.connect(this.select,"startMoveRows",_4.hitch(this,this.clearSort));}this.retainLastRowSelection();this.inSorting=true;this._toggleProgressTip(true,e);this._updateSortAttrs(e,_a);this.focus.addSortFocus(e);if(this.canSort()){this.sort();this.edit.info={};this.update();}this._toggleProgressTip(false,e);this.inSorting=false;}},_updateSortAttrs:function(e,_b){var _c=false;var _d=!!e.unarySortChoice;if(_d){var _e=this.getCellSortInfo(e.cell);var _f=(this.sortAttrs.length>0&&_e["sortPos"]!=1)?_e["unarySortAsc"]:this._getNewSortState(_e["unarySortAsc"]);if(_f&&_f!=0){this.sortAttrs=[{attr:e.cell.field,asc:_f,cell:e.cell,cellNode:e.cellNode}];this._unarySortCell={cell:e.cell,node:e.cellNode};}else{this.sortAttrs=[];this._unarySortCell=null;}}else{this.setCellSortInfo(e,_b);}},getCellSortInfo:function(_10){if(!_10){return false;}var _11=null;var _12=this.sortAttrs;_4.forEach(_12,function(_13,_14,_15){if(_13&&_13["attr"]==_10.field&&_13["cell"]==_10){_11={unarySortAsc:_15[0]?_15[0]["asc"]:undefined,nestedSortAsc:_13["asc"],sortPos:_14+1};}});return _11?_11:{unarySortAsc:_12&&_12[0]?_12[0]["asc"]:undefined,nestedSortAsc:undefined,sortPos:-1};},setCellSortInfo:function(e,_16){var _17=e.cell;var _18=false;var _19=[];var _1a=this.sortAttrs;_4.forEach(_1a,_4.hitch(this,function(_1b,_1c){if(_1b&&_1b["attr"]==_17.field){var si=_16?_16:this._getNewSortState(_1b["asc"]);if(si==1||si==-1){_1b["asc"]=si;}else{if(si==0){_19.push(_1c);}else{throw new Exception("Illegal nested sorting status - "+si);}}_18=true;}}));var _1d=0;_4.forEach(_19,function(_1e){_1a.splice((_1e-_1d++),1);});if(!_18){var si=_16?_16:1;if(si!=0){_1a.push({attr:_17.field,asc:si,cell:e.cell,cellNode:e.cellNode});}}if(_19.length>0){this._unarySortCell={cell:_1a[0]["cell"],node:_1a[0]["cellNode"]};}},_getDsSortAttrs:function(){var _1f=[];var si=null;_4.forEach(this.sortAttrs,function(_20){if(_20&&(_20["asc"]==1||_20["asc"]==-1)){_1f.push({attribute:_20["attr"],descending:(_20["asc"]==-1)});}});return _1f.length>0?_1f:null;},_getNewSortState:function(si){return si?(si==1?-1:(si==-1?0:1)):1;},sortStateInt2Str:function(si){if(!si){return "Unsorted";}switch(si){case 1:return "Ascending";case -1:return "Descending";default:return "Unsorted";}},clearSort:function(){_4.query("[id*='Sort']",this.viewsHeaderNode).forEach(function(_21){_4.addClass(_21,"dojoxGridUnsorted");});this.sortAttrs=[];this.focus.clearHeaderFocus();},_getNestedSortHeaderContent:function(_22){var n=_22.name||_22.grid.getCellName(_22);if(_22.grid.pluginMgr.isFixedCell(_22)){return ["<div class=\"dojoxGridCellContent\">",n,"</div>"].join("");}var _23=_22.grid.getCellSortInfo(_22);var _24=_22.grid.sortAttrs;var _25=(_24&&_24.length>1&&_23["sortPos"]>=1);var _26=(_24&&_24.length==1&&_23["sortPos"]==1);var _27=_22.grid;var ret=["<div class=\"dojoxGridSortRoot\">","<div class=\"dojoxGridSortWrapper\">","<span id=\"selectSortSeparator"+_22.index+"\" class=\"dojoxGridSortSeparatorOff\"></span>","<span class=\"dojoxGridNestedSortWrapper\" tabindex=\"-1\">","<span id=\""+_22.view.id+"SortPos"+_22.index+"\" class=\"dojoxGridSortPos "+(_25?"":"dojoxGridSortPosOff")+"\">"+(_25?_23["sortPos"]:"")+"</span>","<span id=\"nestedSortCol"+_22.index+"\" class=\"dojoxGridSort dojoxGridNestedSort "+(_25?("dojoxGrid"+_27.sortStateInt2Str(_23["nestedSortAsc"])):"dojoxGridUnsorted")+"\">",_27._a11yText["dojoxGrid"+_27.sortStateInt2Str(_23["nestedSortAsc"])]||".","</span>","</span>","<span id=\"SortSeparator"+_22.index+"\" class=\"dojoxGridSortSeparatorOff\"></span>","<span class=\"dojoxGridUnarySortWrapper\" tabindex=\"-1\"><span id=\"unarySortCol"+_22.index+"\" class=\"dojoxGridSort dojoxGridUnarySort "+(_26?("dojoxGrid"+_27.sortStateInt2Str(_23["unarySortAsc"])):"dojoxGridUnsorted")+"\">",_27._a11yText["dojoxGrid"+_27.sortStateInt2Str(_23["unarySortAsc"])]||".","</span></span>","</div>","<div tabindex=\"-1\" id=\"selectCol"+_22.index+"\" class=\"dojoxGridHeaderCellSelectRegion\"><span id=\"caption"+_22.index+"\">"+n+"<span></div>","</div>"];return ret.join("");},addHoverSortTip:function(e){this._sortTipMap[e.cellIndex]=true;var _28=this.getCellSortInfo(e.cell);if(!_28){return;}var _29=this._getCellElements(e.cellNode);if(!_29){return;}var _2a=this.sortAttrs;var _2b=!_2a||_2a.length<1;var _2c=(_2a&&_2a.length==1&&_28["sortPos"]==1);_4.addClass(_29["selectSortSeparator"],"dojoxGridSortSeparatorOn");if(_2b||_2c){this._addHoverUnarySortTip(_29,_28,e);}else{this._addHoverNestedSortTip(_29,_28,e);this.updateMinColWidth(_29["nestedSortPos"]);}var _2d=_29["selectRegion"];this._fixSelectRegion(_2d);if(!_5.hasWaiRole(_2d)){_5.setWaiState(_2d,"label","Column "+(e.cellIndex+1)+" "+e.cell.field);}this._toggleHighlight(e.sourceView,e);this.focus._updateFocusBorder();},_addHoverUnarySortTip:function(_2e,_2f,e){_4.addClass(_2e["nestedSortWrapper"],"dojoxGridUnsorted");var _30=this.sortStateInt2Str(this._getNewSortState(_2f["unarySortAsc"]));_5.setWaiState(_2e["unarySortWrapper"],"label","Column "+(e.cellIndex+1)+" "+e.cell.field+" - Choose "+_30.toLowerCase()+" single sort");var _31="dojoxGrid"+_30+"Tip";_4.addClass(_2e["unarySortChoice"],_31);_2e["unarySortChoice"].innerHTML=this._a11yText[_31];this._addTipInfo(_2e["unarySortWrapper"],this._composeSortTip(_30,"singleSort"));},_addHoverNestedSortTip:function(_32,_33,e){var _34=_32["nestedSortPos"];var _35=_32["unarySortWrapper"];var _36=_32["nestedSortWrapper"];var _37=this.sortAttrs;_4.removeClass(_36,"dojoxGridUnsorted");var _38=this.sortStateInt2Str(this._getNewSortState(_33["nestedSortAsc"]));_5.setWaiState(_36,"label","Column "+(e.cellIndex+1)+" "+e.cell.field+" - Choose "+_38.toLowerCase()+" nested sort");var _39="dojoxGrid"+_38+"Tip";this._addA11yInfo(_32["nestedSortChoice"],_39);this._addTipInfo(_36,this._composeSortTip(_38,"nestedSort"));_38=this.sortStateInt2Str(_33["unarySortAsc"]);_5.setWaiState(_35,"label","Column "+(e.cellIndex+1)+" "+e.cell.field+" - Choose "+_38.toLowerCase()+" single sort");_39="dojoxGrid"+_38+"Tip";this._addA11yInfo(_32["unarySortChoice"],_39);this._addTipInfo(_35,this._composeSortTip(_38,"singleSort"));_4.addClass(_32["sortSeparator"],"dojoxGridSortSeparatorOn");_4.removeClass(_34,"dojoxGridSortPosOff");if(_33["sortPos"]<1){_34.innerHTML=(_37?_37.length:0)+1;if(!this._unarySortInFocus()&&_37&&_37.length==1){var _3a=this._getUnaryNode();_3a.innerHTML="1";_4.removeClass(_3a,"dojoxGridSortPosOff");_4.removeClass(_3a.parentNode,"dojoxGridUnsorted");this._fixSelectRegion(this._getCellElements(_3a)["selectRegion"]);}}},_unarySortInFocus:function(){return this._unarySortCell.cell&&this.focus.headerCellInFocus(this._unarySortCell.cell.index);},_composeSortTip:function(_3b,_3c){_3b=_3b.toLowerCase();if(_3b=="unsorted"){return this._nls[_3b];}else{var tip=_4.string.substitute(this._nls["sortingState"],[this._nls[_3c],this._nls[_3b]]);return tip;}},_addTipInfo:function(_3d,_3e){_4.attr(_3d,"title",_3e);_4.query("span",_3d).forEach(function(n){_4.attr(n,"title",_3e);});},_addA11yInfo:function(_3f,_40){_4.addClass(_3f,_40);_3f.innerHTML=this._a11yText[_40];},removeHoverSortTip:function(e){if(!this._sortTipMap[e.cellIndex]){return;}var _41=this.getCellSortInfo(e.cell);if(!_41){return;}var _42=this._getCellElements(e.cellNode);if(!_42){return;}var _43=_42.nestedSortChoice;var _44=_42.unarySortChoice;var _45=_42.unarySortWrapper;var _46=_42.nestedSortWrapper;this._toggleHighlight(e.sourceView,e,true);function _47(_48){_4.forEach(_48,function(_49){var _4a=_4.trim((" "+_49["className"]+" ").replace(/\sdojoxGrid\w+Tip\s/g," "));if(_49["className"]!=_4a){_49["className"]=_4a;}});};_47([_43,_44]);_44.innerHTML=this._a11yText["dojoxGrid"+this.sortStateInt2Str(_41["unarySortAsc"])]||".";_43.innerHTML=this._a11yText["dojoxGrid"+this.sortStateInt2Str(_41["nestedSortAsc"])]||".";_4.removeClass(_42["selectSortSeparator"],"dojoxGridSortSeparatorOn");_4.removeClass(_42["sortSeparator"],"dojoxGridSortSeparatorOn");if(_41["sortPos"]==1&&this.focus.isNavHeader()&&!this.focus.headerCellInFocus(e.cellIndex)){_4.removeClass(_42["nestedSortWrapper"],"dojoxGridUnsorted");}var _4b=this.sortAttrs;if(!isNaN(_41["sortPos"])&&_41["sortPos"]<1){_42["nestedSortPos"].innerHTML="";_4.addClass(_46,"dojoxGridUnsorted");if(!this.focus._focusBorderBox&&_4b&&_4b.length==1){var _4c=this._getUnaryNode();_4c.innerHTML="";_4.addClass(_4c,"dojoxGridSortPosOff");this._fixSelectRegion(this._getCellElements(_4c)["selectRegion"]);}}this._fixSelectRegion(_42["selectRegion"]);_5.removeWaiState(_46,"label");_5.removeWaiState(_45,"label");if(_41["sortPos"]>=0){var _4d=(_4b.length==1);var _4e=_4d?_45:_46;this._setSortRegionWaiState(_4d,e.cellIndex,e.cell.field,_41["sortPos"],_4e);}this.focus._updateFocusBorder();this._sortTipMap[e.cellIndex]=false;},_getUnaryNode:function(){for(var i=0;i<this.views.views.length;i++){var n=_4.byId(this.views.views[i].id+"SortPos"+this._unarySortCell.cell.index);if(n){return n;}}},_fixSelectRegion:function(_4f){var _50=_4f.previousSibling;var _51=_4.contentBox(_4f.parentNode);var _52=_4.marginBox(_4f);var _53=_4.marginBox(_50);if(_4.isIE&&!_4._isBodyLtr()){var w=0;_4.forEach(_50.childNodes,function(_54){w+=_4.marginBox(_54).w;});_53.w=w;_53.l=(_53.t=0);_4.marginBox(_50,_53);}if(_52.w!=(_51.w-_53.w)){_52.w=_51.w-_53.w;if(!_4.isWebKit){_4.marginBox(_4f,_52);}else{_52.h=_4.contentBox(_51).h;_4.style(_4f,"width",(_52.w-4)+"px");}}},updateMinColWidth:function(_55){if(this._minColWidthUpdated){return;}var _56=_55.innerHTML;_55.innerHTML=_4.query(".dojoxGridSortWrapper",this.viewsHeaderNode).length;var _57=_55.parentNode.parentNode;this._minColWidth=_4.marginBox(_57).w+this._widthDelta;_55.innerHTML=_56;this._minColWidthUpdated=true;},getMinColWidth:function(){return this._minColWidth;},_initSelectCols:function(){var _58=_4.query(".dojoxGridHeaderCellSelectRegion",this.headerContentNode);var _59=_4.query(".dojoxGridUnarySortWrapper",this.headerContentNode);var _5a=_4.query(".dojoxGridNestedSortWrapper",this.headerContentNode);_58.concat(_59).concat(_5a).forEach(function(_5b){_4.connect(_5b,"onmousemove",_4.hitch(this.grid,this.grid._toggleHighlight,this));_4.connect(_5b,"onmouseout",_4.hitch(this.grid,this.grid._removeActiveState));},this);this.grid._fixHeaderCellStyle(_58,this);if(_4.isIE&&!_4._isBodyLtr()){this.grid._fixAllSelectRegion();}},_fixHeaderCellStyle:function(_5c,_5d){_4.forEach(_5c,_4.hitch(this,function(_5e){var _5f=_4.marginBox(_5e),_60=this._getCellElements(_5e),_61=_60.sortWrapper;_61.style.height=_5f.h+"px";_61.style.lineHeight=_5f.h+"px";var _62=_60["selectSortSeparator"],_63=_60["sortSeparator"];_63.style.height=_62.style.height=_5f.h*3/5+"px";_63.style.marginTop=_62.style.marginTop=_5f.h*1/5+"px";_5d.header.overResizeWidth=this._overResizeWidth;}));},_fixAllSelectRegion:function(){var _64=_4.query(".dojoxGridHeaderCellSelectRegion",this.viewsHeaderNode);_4.forEach(_64,_4.hitch(this,function(_65){this._fixSelectRegion(_65);}));},_toggleHighlight:function(_66,e,_67){if(!e.target||!e.type||!e.type.match(/mouse|contextmenu/)){return;}var _68=this._getCellElements(e.target);if(!_68){return;}var _69=_68["selectRegion"];var _6a=_68["nestedSortWrapper"];var _6b=_68["unarySortWrapper"];_4.removeClass(_69,"dojoxGridSelectRegionHover");_4.removeClass(_6a,"dojoxGridSortHover");_4.removeClass(_6b,"dojoxGridSortHover");if(!_67&&!_66.grid._inResize(_66)){var _6c=this._getSortEventInfo(e);if(_6c.selectChoice){_4.addClass(_69,"dojoxGridSelectRegionHover");}else{if(_6c.nestedSortChoice){_4.addClass(_6a,"dojoxGridSortHover");}else{if(_6c.unarySortChoice){_4.addClass(_6b,"dojoxGridSortHover");}}}}},_removeActiveState:function(e){if(!e.target||!e.type||!e.type.match(/mouse|contextmenu/)){return;}var _6d=this._getChoiceRegion(e.target,this._getSortEventInfo(e));_6d&&_4.removeClass(_6d,this.headerCellActiveClass);},_toggleProgressTip:function(on,e){var _6e=[this.domNode,e?e.cellNode:null];setTimeout(function(){_4.forEach(_6e,function(_6f){if(_6f){if(on&&!_4.hasClass(_6f,"dojoxGridSortInProgress")){_4.addClass(_6f,"dojoxGridSortInProgress");}else{if(!on&&_4.hasClass(_6f,"dojoxGridSortInProgress")){_4.removeClass(_6f,"dojoxGridSortInProgress");}}}});},0.1);},_getSortEventInfo:function(e){var _70=function(_71,css){return _4.hasClass(_71,css)||(_71.parentNode&&_4.hasClass(_71.parentNode,css));};return {selectChoice:_70(e.target,"dojoxGridHeaderCellSelectRegion"),unarySortChoice:_70(e.target,"dojoxGridUnarySortWrapper"),nestedSortChoice:_70(e.target,"dojoxGridNestedSortWrapper")};},ignoreEvent:function(e){return !(e.nestedSortChoice||e.unarySortChoice||e.selectChoice);},doheaderclick:function(e){if(this.nestedSorting){if(e.selectChoice){this.onHeaderCellSelectClick(e);}else{if((e.unarySortChoice||e.nestedSortChoice)&&!this._inResize(e.sourceView)){this.onHeaderCellSortClick(e);}}return;}this.inherited(arguments);},onHeaderCellSelectClick:function(e){},onHeaderCellSortClick:function(e){this.setSortIndex(e.cell.index,null,e);},_sychronizeResize:function(e){if(!e.cell||e.cell.isRowSelector||this.focus.headerCellInFocus(e.cellIndex)){return;}if(!this._inResize(e.sourceView)){this.addHoverSortTip(e);}else{var idx=e.cellIndex;if(!this._sortTipMap[e.cellIndex]){e.cellIndex=this._sortTipMap[idx+1]?(idx+1):(this._sortTipMap[idx-1]?(idx-1):idx);e.cellNode=e.cellNode.parentNode.childNodes[e.cellIndex];}this.removeHoverSortTip(e);}},_getCellElements:function(_72){try{while(_72&&_72.nodeName.toLowerCase()!="th"){_72=_72.parentNode;}if(!_72){return null;}var ns=_4.query(".dojoxGridSortRoot",_72);if(ns.length!=1){return null;}var n=ns[0];return {"selectSortSeparator":_4.query("[id^='selectSortSeparator']",n)[0],"nestedSortPos":_4.query(".dojoxGridSortPos",n)[0],"nestedSortChoice":_4.query("[id^='nestedSortCol']",n)[0],"sortSeparator":_4.query("[id^='SortSeparator']",n)[0],"unarySortChoice":_4.query("[id^='unarySortCol']",n)[0],"selectRegion":_4.query(".dojoxGridHeaderCellSelectRegion",n)[0],"sortWrapper":_4.query(".dojoxGridSortWrapper",n)[0],"unarySortWrapper":_4.query(".dojoxGridUnarySortWrapper",n)[0],"nestedSortWrapper":_4.query(".dojoxGridNestedSortWrapper",n)[0],"sortRoot":n,"headCellNode":_72};}catch(e){console.debug("NestedSorting._getCellElemets() error:"+e);}return null;},_getChoiceRegion:function(_73,_74){var _75,_76=this._getCellElements(_73);if(!_76){return;}_74.unarySortChoice&&(_75=_76["unarySortWrapper"]);_74.nestedSortChoice&&(_75=_76["nestedSortWrapper"]);_74.selectChoice&&(_75=_76["selectRegion"]);return _75;},_inResize:function(_77){return _77.header.moverDiv||_4.hasClass(_77.headerNode,"dojoxGridColResize")||_4.hasClass(_77.headerNode,"dojoxGridColNoResize");},retainLastRowSelection:function(){_4.forEach(this._by_idx,function(o,idx){if(!o||!o.item){return;}var _78=!!this.selection.isSelected(idx);o.item[this.storeItemSelected]=[_78];if(this.indirectSelection&&this.rowSelectCell.toggleAllTrigerred&&_78!=this.toggleAllValue){this.exceptionalSelectedItems.push(o.item);}},this);this.selection.clear();_4.publish(this.sortRowSelectionChangedTopic,[this]);},updateNewRowSelection:function(_79,req){_4.forEach(_79,function(_7a,idx){if(this.indirectSelection&&this.rowSelectCell.toggleAllTrigerred){if(_4.indexOf(this.exceptionalSelectedItems,_7a)<0){_7a[this.storeItemSelected]=[this.toggleAllValue];}}_7a[this.storeItemSelected]&&_7a[this.storeItemSelected][0]&&this.selection.addToSelection(req.start+idx);},this);_4.publish(this.sortRowSelectionChangedTopic,[this]);if(_4.isMoz&&this._by_idx.length==0){this.update();}},allSelectionToggled:function(_7b){this.exceptionalSelectedItems=[];this.toggleAllValue=this.rowSelectCell.defaultValue;},_selectionChanged:function(obj){obj==this.select&&(this.toggleAllValue=false);},getStoreSelectedValue:function(_7c){var _7d=this._by_idx[_7c];return _7d&&_7d.item&&!!(_7d.item[this.storeItemSelected]&&_7d.item[this.storeItemSelected][0]);},initAriaInfo:function(){var _7e=this.sortAttrs;_4.forEach(_7e,_4.hitch(this,function(_7f,_80){var _81=_7f.cell.getHeaderNode();var _82=this._getCellElements(_81);if(!_82){return;}var _83=_82["selectRegion"];_5.setWaiState(_83,"label","Column "+(_7f.cell.index+1)+" "+_7f.attr);var _84=(_7e.length==1);var _85=this.sortStateInt2Str(_7f.asc).toLowerCase();var _86=_84?_82["unarySortWrapper"]:_82["nestedSortWrapper"];_5.setWaiState(_86,"sort",_85);this._setSortRegionWaiState(_84,_7f.cell.index,_7f.attr,_80+1,_86);}));},_setSortRegionWaiState:function(_87,_88,_89,_8a,_8b){if(_8a<0){return;}var _8c=_87?"single sort":"nested sort";var _8d="Column "+(_88+1)+" "+_89+" "+_8c+" "+(!_87?(" sort position "+_8a):"");_5.setWaiState(_8b,"label",_8d);},_inPage:function(_8e){return _8e<this._bop||_8e>=this._eop;}});_4.declare("dojox.grid.enhanced.plugins._NestedSortingFocusManager",_6.grid._FocusManager,{lastHeaderFocus:{cellNode:null,regionIdx:-1},currentHeaderFocusEvt:null,cssMarkers:["dojoxGridHeaderCellSelectRegion","dojoxGridNestedSortWrapper","dojoxGridUnarySortWrapper"],_focusBorderBox:null,_initColumnHeaders:function(){var _8f=this._findHeaderCells();_4.forEach(_8f,_4.hitch(this,function(_90){var _91=_4.query(".dojoxGridHeaderCellSelectRegion",_90);var _92=_4.query("[class*='SortWrapper']",_90);_91=_91.concat(_92);_91.length==0&&(_91=[_90]);_4.forEach(_91,_4.hitch(this,function(_93){this._connects.push(_4.connect(_93,"onfocus",this,"doColHeaderFocus"));this._connects.push(_4.connect(_93,"onblur",this,"doColHeaderBlur"));}));}));},focusHeader:function(_94,_95,_96){if(!this.isNavHeader()){this.inherited(arguments);}else{var _97=this._findHeaderCells();this._colHeadNode=_97[this._colHeadFocusIdx];_95&&(this.lastHeaderFocus.cellNode=this._colHeadNode);}if(!this._colHeadNode){return;}if(this.grid.indirectSelection&&this._colHeadFocusIdx==0){this._colHeadNode=this._findHeaderCells()[++this._colHeadFocusIdx];}var _98=_96?0:(this.lastHeaderFocus.regionIdx>=0?this.lastHeaderFocus.regionIdx:(_94?2:0));var _99=_4.query("."+this.cssMarkers[_98],this._colHeadNode)[0]||this._colHeadNode;this.grid.addHoverSortTip(this.currentHeaderFocusEvt=this._mockEvt(_99));this.lastHeaderFocus.regionIdx=_98;_99&&_6.grid.util.fire(_99,"focus");},focusSelectColEndingHeader:function(e){if(!e||!e.cellNode){return;}this._colHeadFocusIdx=e.cellIndex;this.focusHeader(null,false,true);},_delayedHeaderFocus:function(){this.isNavHeader()&&this.focusHeader(null,true);},_setActiveColHeader:function(_9a,_9b,_9c){_4.attr(this.grid.domNode,"aria-activedescendant",_9a.id);this._colHeadNode=_9a;this._colHeadFocusIdx=_9b;},doColHeaderFocus:function(e){this.lastHeaderFocus.cellNode=this._colHeadNode;if(e.target==this._colHeadNode){this._scrollHeader(this.getHeaderIndex());}else{var _9d=this.getFocusView(e);if(!_9d){return;}_9d.header.baseDecorateEvent(e);this._addFocusBorder(e.target);this._colHeadFocusIdx=e.cellIndex;this._colHeadNode=this._findHeaderCells()[this._colHeadFocusIdx];this._colHeadNode&&this.getHeaderIndex()!=-1&&this._scrollHeader(this._colHeadFocusIdx);}this._focusifyCellNode(false);this.grid.isDndSelectEnable&&this.grid.focus._blurRowBar();this.grid.addHoverSortTip(this.currentHeaderFocusEvt=this._mockEvt(e.target));if(_4.isIE&&!_4._isBodyLtr()){this.grid._fixAllSelectRegion();}},doColHeaderBlur:function(e){this.inherited(arguments);this._removeFocusBorder();if(!this.isNavCellRegion){var _9e=this.getFocusView(e);if(!_9e){return;}_9e.header.baseDecorateEvent(e);this.grid.removeHoverSortTip(e);this.lastHeaderFocus.cellNode=this._colHeadNode;}},getFocusView:function(e){var _9f;_4.forEach(this.grid.views.views,function(_a0){if(!_9f){var _a1=_4.coords(_a0.domNode),_a2=_4.coords(e.target);var _a3=_a2.x>=_a1.x&&_a2.x<=(_a1.x+_a1.w);_a3&&(_9f=_a0);}});return (this.focusView=_9f);},_mockEvt:function(_a4){var _a5=this.grid.getCell(this._colHeadFocusIdx);return {target:_a4,cellIndex:this._colHeadFocusIdx,cell:_a5,cellNode:this._colHeadNode,clientX:-1,sourceView:_a5.view};},navHeader:function(e){var _a6=e.ctrlKey?0:(e.keyCode==_4.keys.LEFT_ARROW)?-1:1;!_4._isBodyLtr()&&(_a6*=-1);this.focusView.header.baseDecorateEvent(e);_4.forEach(this.cssMarkers,_4.hitch(this,function(css,_a7){if(_4.hasClass(e.target,css)){var _a8=_a7+_a6,_a9,_aa;do{_a9=_4.query("."+this.cssMarkers[_a8],e.cellNode)[0];if(_a9&&_4.style(_a9.lastChild||_a9.firstChild,"display")!="none"){_aa=_a9;break;}_a8+=_a6;}while(_a8>=0&&_a8<this.cssMarkers.length);if(_aa&&_a8>=0&&_a8<this.cssMarkers.length){if(e.ctrlKey){return;}_4.isIE&&(this.grid._sortTipMap[e.cellIndex]=false);this.navCellRegion(_aa,_a8);return;}var _ab=_a8<0?-1:(_a8>=this.cssMarkers.length?1:0);this.navHeaderNode(_ab);}}));},navHeaderNode:function(_ac,_ad){var _ae=this._colHeadFocusIdx+_ac;var _af=this._findHeaderCells();while(_ae>=0&&_ae<_af.length&&_af[_ae].style.display=="none"){_ae+=_ac;}if(this.grid.indirectSelection&&_ae==0){return;}if(_ac!=0&&_ae>=0&&_ae<this.grid.layout.cells.length){this.lastHeaderFocus.cellNode=this._colHeadNode;this.lastHeaderFocus.regionIdx=-1;this._colHeadFocusIdx=_ae;this.focusHeader(_ac<0?true:false,false,_ad);}},navCellRegion:function(_b0,_b1){this.isNavCellRegion=true;_6.grid.util.fire(_b0,"focus");this.currentHeaderFocusEvt.target=_b0;this.lastHeaderFocus.regionIdx=_b1;var _b2=_b1==0?_b0:_b0.parentNode.nextSibling;_b2&&this.grid._fixSelectRegion(_b2);this.isNavCellRegion=false;},headerCellInFocus:function(_b3){return (this._colHeadFocusIdx==_b3)&&this._focusBorderBox;},clearHeaderFocus:function(){this._colHeadNode=this._colHeadFocusIdx=null;this.lastHeaderFocus={cellNode:null,regionIdx:-1};},addSortFocus:function(e){var _b4=this.grid.getCellSortInfo(e.cell);if(!_b4){return;}var _b5=this.grid.sortAttrs;var _b6=!_b5||_b5.length<1;var _b7=(_b5&&_b5.length==1&&_b4["sortPos"]==1);this._colHeadFocusIdx=e.cellIndex;this._colHeadNode=e.cellNode;this.currentHeaderFocusEvt={};this.lastHeaderFocus.regionIdx=(_b6||_b7)?2:(e.nestedSortChoice?1:0);},_addFocusBorder:function(_b8){if(!_b8){return;}this._removeFocusBorder();this._focusBorderBox=_4.create("div");this._focusBorderBox.className="dojoxGridFocusBorderBox";_4.toggleClass(_b8,"dojoxGridSelectRegionFocus",true);_4.toggleClass(_b8,"dojoxGridSelectRegionHover",false);var _b9=_b8.offsetHeight;if(_b8.hasChildNodes()){_b8.insertBefore(this._focusBorderBox,_b8.firstChild);}else{_b8.appendChild(this._focusBorderBox);}var _ba={"l":0,"t":0,"r":0,"b":0};for(var i in _ba){_ba[i]=_4.create("div");}var pos={x:_4.coords(_b8).x-_4.coords(this._focusBorderBox).x,y:_4.coords(_b8).y-_4.coords(this._focusBorderBox).y,w:_b8.offsetWidth,h:_b9};for(var i in _ba){var n=_ba[i];_4.addClass(n,"dojoxGridFocusBorder");_4.style(n,"top",pos.y+"px");_4.style(n,"left",pos.x+"px");this._focusBorderBox.appendChild(n);}var _bb=function(val){return val>0?val:0;};_4.style(_ba.r,"left",_bb(pos.x+pos.w-1)+"px");_4.style(_ba.b,"top",_bb(pos.y+pos.h-1)+"px");_4.style(_ba.l,"height",_bb(pos.h-1)+"px");_4.style(_ba.r,"height",_bb(pos.h-1)+"px");_4.style(_ba.t,"width",_bb(pos.w-1)+"px");_4.style(_ba.b,"width",_bb(pos.w-1)+"px");},_updateFocusBorder:function(){if(this._focusBorderBox==null){return;}this._addFocusBorder(this._focusBorderBox.parentNode);},_removeFocusBorder:function(){if(this._focusBorderBox&&this._focusBorderBox.parentNode){_4.toggleClass(this._focusBorderBox.parentNode,"dojoxGridSelectRegionFocus",false);this._focusBorderBox.parentNode.removeChild(this._focusBorderBox);}this._focusBorderBox=null;}});}}};});