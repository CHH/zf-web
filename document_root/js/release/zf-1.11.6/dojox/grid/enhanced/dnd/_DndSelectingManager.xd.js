/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.grid.enhanced.dnd._DndSelectingManager"],["require","dojox.grid.util"],["require","dojox.grid._Builder"],["require","dojox.grid.enhanced.dnd._DndGrid"],["require","dojox.grid.enhanced.dnd._DndBuilder"],["require","dojox.grid.enhanced.dnd._DndRowSelector"],["require","dojox.grid.enhanced.dnd._DndFocusManager"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.grid.enhanced.dnd._DndSelectingManager"]){_4._hasResource["dojox.grid.enhanced.dnd._DndSelectingManager"]=true;_4.provide("dojox.grid.enhanced.dnd._DndSelectingManager");_4.require("dojox.grid.util");_4.require("dojox.grid._Builder");_4.require("dojox.grid.enhanced.dnd._DndGrid");_4.require("dojox.grid.enhanced.dnd._DndBuilder");_4.require("dojox.grid.enhanced.dnd._DndRowSelector");_4.require("dojox.grid.enhanced.dnd._DndFocusManager");_4.declare("dojox.grid.enhanced.dnd._DndSelectingManager",null,{typeSelectingMode:[],selectingDisabledTypes:[],drugSelectionStart:null,drugCurrentPoint:null,drugMode:null,keepState:false,extendSelect:false,headerNodes:null,selectedCells:null,selectedColumns:[],selectedClass:"dojoxGridRowSelected",autoScrollRate:1000,constructor:function(_7){this.grid=_7;this.typeSelectingMode=[];this.selectingDisabledTypes=[];this.selectedColumns=[];this.drugSelectionStart=new Object();this.drugCurrentPoint=new Object();this.resetStartPoint();this.extendGridForDnd(_7);this.selectedCells=[];_4.connect(this.grid,"_onFetchComplete",_4.hitch(this,"refreshColumnSelection"));_4.connect(this.grid.scroller,"scroll",_4.hitch(this,"refreshColumnSelection"));_4.subscribe(this.grid.rowSelectionChangedTopic,_4.hitch(this,function(_8){try{if(_8.grid==this.grid&&_8!=this){this.cleanCellSelection();}}catch(e){console.debug(e);}}));},extendGridForDnd:function(_9){var _a=_9.constructor;_9.mixin(_9,_4.hitch(new _6.grid.enhanced.dnd._DndGrid(this)));_9.constructor=_a;_9.mixin(_9.focus,new _6.grid.enhanced.dnd._DndFocusManager());_9.mixin(_9.selection,{clickSelect:function(){}});_4.forEach(_9.views.views,function(_b){_9.mixin(_b.content,new _6.grid.enhanced.dnd._DndBuilder());_9.mixin(_b.header,new _6.grid.enhanced.dnd._DndHeaderBuilder());if(_b.declaredClass=="dojox.grid._RowSelector"){_9.mixin(_b,new _6.grid.enhanced.dnd._DndRowSelector());}_6.grid.util.funnelEvents(_b.contentNode,_b,"doContentEvent",["mouseup"]);_6.grid.util.funnelEvents(_b.headerNode,_b,"doHeaderEvent",["mouseup"]);});_4.forEach(this.grid.dndDisabledTypes,function(_c){this.disableSelecting(_c);},this);this.disableFeatures();},disableFeatures:function(){if(this.selectingDisabledTypes["cell"]){this.cellClick=function(){};this.drugSelectCell=function(){};}if(this.selectingDisabledTypes["row"]){this.drugSelectRow=function(){};}if(this.selectingDisabledTypes["col"]){this.selectColumn=function(){};this.drugSelectColumn=function(){};}},disableSelecting:function(_d){this.selectingDisabledTypes[_d]=true;},isInSelectingMode:function(_e){return !!this.typeSelectingMode[_e];},setInSelectingMode:function(_f,_10){this.typeSelectingMode[_f]=_10;},getSelectedRegionInfo:function(){var _11=[],_12="";if(this.selectedColumns.length>0){_12="col";_4.forEach(this.selectedColumns,function(_13,_14){!!_13&&_11.push(_14);});}else{if(this.grid.selection.getSelectedCount()>0){_12="row";_11=_6.grid.Selection.prototype.getSelected.call(this.grid.selection);}}return {"selectionType":_12,"selectedIdx":_11};},clearInSelectingMode:function(){this.typeSelectingMode=[];},getHeaderNodes:function(){return this.headerNodes==null?_4.query("[role*='columnheader']",this.grid.viewsHeaderNode):this.headerNode;},_range:function(_15,_16,_17){var s=(_15>=0?_15:_16),e=_16;if(s>e){e=s;s=_16;}for(var i=s;i<=e;i++){_17(i);}},cellClick:function(_18,_19){if(_18>this.exceptColumnsTo){this.grid.selection.clear();this.publishRowChange();var _1a=this.getCellNode(_18,_19);this.cleanAll();this.addCellToSelection(_1a);}},setDrugStartPoint:function(_1b,_1c){this.drugSelectionStart.colIndex=_1b;this.drugSelectionStart.rowIndex=_1c;this.drugCurrentPoint.colIndex=_1b;this.firstOut=true;var _1d=_4.connect(_4.doc,"onmousemove",_4.hitch(this,function(e){this.outRangeValue=e.clientY-_4.coords(this.grid.domNode).y-this.grid.domNode.offsetHeight;if(this.outRangeValue>0){if(this.drugSelectionStart.colIndex==-1){if(!this.outRangeY){this.autoRowScrollDrug(e);}}else{if(this.drugSelectionStart.rowIndex==-1){}else{this.autoCellScrollDrug(e);}}}else{this.firstOut=true;this.outRangeY=false;}}));var _1e=_4.connect(_4.doc,"onmouseup",_4.hitch(this,function(e){this.outRangeY=false;_4.disconnect(_1e);_4.disconnect(_1d);this.grid.onMouseUp(e);}));},autoRowScrollDrug:function(e){this.outRangeY=true;this.autoSelectNextRow();},autoSelectNextRow:function(){if(this.grid.select.outRangeY){this.grid.scrollToRow(this.grid.scroller.firstVisibleRow+1);this.drugSelectRow(this.drugCurrentPoint.rowIndex+1);setTimeout(_4.hitch(this,"autoSelectNextRow",this.drugCurrentPoint.rowIndex+1),this.getAutoScrollRate());}},autoCellScrollDrug:function(e){var _1f=null;_4.forEach(this.getHeaderNodes(),function(_20){var _21=_4.coords(_20);if(e.clientX>=_21.x&&e.clientX<=_21.x+_21.w){_1f=Number(_20.attributes.getNamedItem("idx").value);}});if(_1f!=this.drugCurrentPoint.colIndex||this.firstOut){if(!this.firstOut){this.colChanged=true;this.drugCurrentPoint.colIndex=_1f;}this.firstOut=false;this.outRangeY=true;_4.hitch(this,"autoSelectCellInNextRow")();}},autoSelectCellInNextRow:function(){if(this.grid.select.outRangeY){this.grid.scrollToRow(this.grid.scroller.firstVisibleRow+1);this.drugSelectCell(this.drugCurrentPoint.colIndex,this.drugCurrentPoint.rowIndex+1);if(this.grid.select.colChanged){this.grid.select.colChanged=false;}else{setTimeout(_4.hitch(this,"autoSelectCellInNextRow",this.drugCurrentPoint.rowIndex+1),this.getAutoScrollRate());}}},getAutoScrollRate:function(){return this.autoScrollRate;},resetStartPoint:function(){if(this.drugSelectionStart.colIndex==-1&&this.drugSelectionStart.rowIndex==-1){return;}this.lastDrugSelectionStart=_4.clone(this.drugSelectionStart);this.drugSelectionStart.colIndex=-1;this.drugSelectionStart.rowIndex=-1;},restorLastDragPoint:function(){this.drugSelectionStart=_4.clone(this.lastDrugSelectionStart);},drugSelectCell:function(_22,_23){this.cleanAll();this.drugCurrentPoint.columnIndex=_22;this.drugCurrentPoint.rowIndex=_23;var _24,_25,_26,_27;if(_23<this.drugSelectionStart.rowIndex){_24=_23;_25=this.drugSelectionStart.rowIndex;}else{_24=this.drugSelectionStart.rowIndex;_25=_23;}if(_22<this.drugSelectionStart.colIndex){_26=_22;_27=this.drugSelectionStart.colIndex;}else{_26=this.drugSelectionStart.colIndex;_27=_22;}for(var i=_26;i<=_27;i++){this.addColumnRangeToSelection(i,_24,_25);}},selectColumn:function(_28){this.addColumnToSelection(_28);},drugSelectColumn:function(_29){this.selectColumnRange(this.drugSelectionStart.colIndex,_29);},drugSelectColumnToMax:function(dir){if(dir=="left"){this.selectColumnRange(this.drugSelectionStart.colIndex,0);}else{this.selectColumnRange(this.drugSelectionStart.colIndex,this.getHeaderNodes().length-1);}},selectColumnRange:function(_2a,_2b){if(!this.keepState){this.cleanAll();}this._range(_2a,_2b,_4.hitch(this,"addColumnToSelection"));},addColumnToSelection:function(_2c){this.selectedColumns[_2c]=true;_4.toggleClass(this.getHeaderNodes()[_2c],"dojoxGridHeaderSelected",true);this._rangCellsInColumn(_2c,-1,Number.POSITIVE_INFINITY,this.addCellToSelection);},addColumnRangeToSelection:function(_2d,_2e,to){var _2f=this.grid.views;var _30=[];var _31=this;_4.forEach(_2f.views,function(_32){_4.forEach(this.getViewRowNodes(_32.rowNodes),function(_33,_34){if(!_33){return;}if(_34>=_2e&&_34<=to){_4.forEach(_33.firstChild.rows[0].cells,function(_35){if(_35&&_35.attributes&&(idx=_35.attributes.getNamedItem("idx"))&&Number(idx.value)==_2d){_31.addCellToSelection(_35);}});}},this);},this);},_rangCellsInColumn:function(_36,_37,to,_38){var _39=this.grid.views;var _3a=[];var _3b=this;_4.forEach(_39.views,function(_3c){_4.forEach(this.getViewRowNodes(_3c.rowNodes),function(_3d,_3e){if(!_3d){return;}if(_3e>=_37&&_3e<=to){_4.forEach(_3d.firstChild.rows[0].cells,function(_3f){if(_3f&&_3f.attributes&&(idx=_3f.attributes.getNamedItem("idx"))&&Number(idx.value)==_36){_38(_3f,_3b);}});}},this);},this);},drugSelectRow:function(_40){this.drugCurrentPoint.rowIndex=_40;this.cleanCellSelection();this.clearDrugDivs();var _41=this.grid.selection;_41._beginUpdate();if(!this.keepState){_41.deselectAll();}_41.selectRange(this.drugSelectionStart.rowIndex,_40);_41._endUpdate();this.publishRowChange();},drugSelectRowToMax:function(dir){if(dir=="up"){this.drugSelectRow(0);}else{this.drugSelectRow(this.grid.rowCount);}},getCellNode:function(_42,_43){var _44=[],_45=null;var _46=this.grid.views;for(var i=0,v,n;(v=_46.views[i])&&(n=v.getRowNode(_43));i++){_44.push(n);}_4.forEach(_44,_4.hitch(function(_47,_48){if(_45){return;}var _49=_4.query("[idx='"+_42+"']",_47);if(_49&&_49[0]){_45=_49[0];}}));return _45;},addCellToSelection:function(_4a,_4b){if(!_4b){_4b=this;}_4b.selectedCells[_4b.selectedCells.length]=_4a;_4.toggleClass(_4a,_4b.selectedClass,true);},isColSelected:function(_4c){return this.selectedColumns[_4c];},isRowSelected:function(_4d){return this.grid.selection.selected[_4d];},isContinuousSelection:function(_4e){var _4f=-1;for(var i=0;i<_4e.length;i++){if(!_4e[i]){continue;}if(_4f<0||i-_4f==1){_4f=i;}else{if(i-_4f>=2){return false;}}}return _4f>=0?true:false;},cleanCellSelection:function(){_4.forEach(this.selectedCells,_4.hitch(this,"removeCellSelectedState"));this.selectedCells=[];_4.forEach(this.selectedColumns,function(_50,_51){if(_50){_4.toggleClass(this.getHeaderNodes()[_51],"dojoxGridHeaderSelected",false);}},this);this.selectedColumns=[];this.grid.edit.isEditing()&&this.grid.edit.apply();},removeCellSelectedState:function(_52){_4.toggleClass(_52,this.selectedClass,false);},cleanAll:function(){this.cleanCellSelection();this.grid.selection.clear();this.publishRowChange();},refreshColumnSelection:function(){_4.forEach(this.selectedColumns,_4.hitch(this,function(_53,_54){if(_53){this.grid.select.addColumnToSelection(_54);}}));},inSelectedArea:function(_55,_56){return this.selectedColumns[_55]||this.gird.selection.selecteded[_56];},publishRowChange:function(){_4.publish(this.grid.rowSelectionChangedTopic,[this]);},getViewRowNodes:function(_57){var _58=[];for(i in _57){_58.push(_57[i]);}return _58;},getFirstSelected:function(){return _4.hitch(this.grid.selection,_6.grid.Selection.prototype.getFirstSelected)();},getLastSelected:function(){var _59=this.grid.selection.selected;for(var i=_59.length-1;i>=0;i--){if(_59[i]){return i;}}return -1;}});}}};});