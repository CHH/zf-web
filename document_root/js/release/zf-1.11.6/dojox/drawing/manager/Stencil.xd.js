/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.drawing.manager.Stencil"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.drawing.manager.Stencil"]){_4._hasResource["dojox.drawing.manager.Stencil"]=true;_4.provide("dojox.drawing.manager.Stencil");(function(){var _7,_8;_6.drawing.manager.Stencil=_6.drawing.util.oo.declare(function(_9){_7=_9.surface;this.canvas=_9.canvas;this.defaults=_6.drawing.defaults.copy();this.undo=_9.undo;this.mouse=_9.mouse;this.keys=_9.keys;this.anchors=_9.anchors;this.stencils={};this.selectedStencils={};this._mouseHandle=this.mouse.register(this);_4.connect(this.keys,"onArrow",this,"onArrow");_4.connect(this.keys,"onEsc",this,"deselect");_4.connect(this.keys,"onDelete",this,"onDelete");},{_dragBegun:false,_wasDragged:false,_secondClick:false,_isBusy:false,register:function(_a){console.log("Selection.register ::::::",_a.id);if(_a.isText&&!_a.editMode&&_a.deleteEmptyCreate&&!_a.getText()){console.warn("EMPTY CREATE DELETE",_a);_a.destroy();return false;}this.stencils[_a.id]=_a;if(_a.execText){if(_a._text&&!_a.editMode){console.log("select text");this.selectItem(_a);}_a.connect("execText",this,function(){if(_a.isText&&_a.deleteEmptyModify&&!_a.getText()){console.warn("EMPTY MOD DELETE",_a);this.deleteItem(_a);}else{if(_a.selectOnExec){this.selectItem(_a);}}});}_a.connect("deselect",this,function(){if(!this._isBusy&&this.isSelected(_a)){this.deselectItem(_a);}});_a.connect("select",this,function(){if(!this._isBusy&&!this.isSelected(_a)){this.selectItem(_a);}});return _a;},unregister:function(_b){console.log("Selection.unregister ::::::",_b.id,"sel:",_b.selected);if(_b){_b.selected&&this.onDeselect(_b);delete this.stencils[_b.id];}},onArrow:function(_c){if(this.hasSelected()){this.saveThrottledState();this.group.applyTransform({dx:_c.x,dy:_c.y});}},_throttleVrl:null,_throttle:false,throttleTime:400,_lastmxx:-1,_lastmxy:-1,saveMoveState:function(){var mx=this.group.getTransform();if(mx.dx==this._lastmxx&&mx.dy==this._lastmxy){return;}this._lastmxx=mx.dx;this._lastmxy=mx.dy;this.undo.add({before:_4.hitch(this.group,"setTransform",mx)});},saveThrottledState:function(){clearTimeout(this._throttleVrl);clearInterval(this._throttleVrl);this._throttleVrl=setTimeout(_4.hitch(this,function(){this._throttle=false;this.saveMoveState();}),this.throttleTime);if(this._throttle){return;}this._throttle=true;this.saveMoveState();},unDelete:function(_d){console.log("unDelete:",_d);for(var s in _d){_d[s].render();this.onSelect(_d[s]);}},onDelete:function(_e){console.log("onDelete",_e);if(_e!==true){this.undo.add({before:_4.hitch(this,"unDelete",this.selectedStencils),after:_4.hitch(this,"onDelete",true)});}this.withSelected(function(m){this.anchors.remove(m);var id=m.id;console.log("delete:",m);m.destroy();delete this.stencils[id];});this.selectedStencils={};},deleteItem:function(_f){if(this.hasSelected()){var _10=[];for(var m in this.selectedStencils){if(this.selectedStencils.id==_f.id){if(this.hasSelected()==1){this.onDelete();return;}}else{_10.push(this.selectedStencils.id);}}this.deselect();this.selectItem(_f);this.onDelete();_4.forEach(_10,function(id){this.selectItem(id);},this);}else{this.selectItem(_f);this.onDelete();}},removeAll:function(){this.selectAll();this._isBusy=true;this.onDelete();this.stencils={};this._isBusy=false;},setSelectionGroup:function(){this.withSelected(function(m){this.onDeselect(m,true);});if(this.group){_7.remove(this.group);this.group.removeShape();}this.group=_7.createGroup();this.group.setTransform({dx:0,dy:0});this.withSelected(function(m){this.group.add(m.container);m.select();});},setConstraint:function(){var t=Infinity;l=Infinity;this.withSelected(function(m){var o=m.getBounds();t=Math.min(o.y1,t);l=Math.min(o.x1,l);});this.constrain={l:-l,t:-t};},onDeselect:function(_11,_12){if(!_12){delete this.selectedStencils[_11.id];}this.anchors.remove(_11);_7.add(_11.container);_11.selected&&_11.deselect();_11.applyTransform(this.group.getTransform());},deselectItem:function(_13){this.onDeselect(_13);},deselect:function(){this.withSelected(function(m){this.onDeselect(m);});this._dragBegun=false;this._wasDragged=false;},onSelect:function(_14){if(!_14){console.error("null stencil is not selected:",this.stencils);}if(this.selectedStencils[_14.id]){return;}this.selectedStencils[_14.id]=_14;this.group.add(_14.container);_14.select();if(this.hasSelected()==1){this.anchors.add(_14,this.group);}},selectAll:function(){this._isBusy=true;for(var m in this.stencils){this.selectItem(m);}this._isBusy=false;},selectItem:function(_15){var id=typeof (_15)=="string"?_15:_15.id;var _16=this.stencils[id];this.setSelectionGroup();this.onSelect(_16);this.group.moveToFront();this.setConstraint();},onStencilDoubleClick:function(obj){console.info("mgr.onStencilDoubleClick:",obj);if(this.selectedStencils[obj.id]){if(this.selectedStencils[obj.id].edit){console.info("Mgr Stencil Edit -> ",this.selectedStencils[obj.id]);var m=this.selectedStencils[obj.id];m.editMode=true;this.deselect();m.edit();}}},onAnchorUp:function(){this.setConstraint();},onStencilDown:function(obj,evt){console.info(" >>> onStencilDown:",obj.id,this.keys.meta);if(!this.stencils[obj.id]){return;}this._isBusy=true;if(this.selectedStencils[obj.id]&&this.keys.meta){if(_4.isMac&&this.keys.cmmd){}console.log("    shift remove");this.onDeselect(this.selectedStencils[obj.id]);if(this.hasSelected()==1){this.withSelected(function(m){this.anchors.add(m,this.group);});}this.group.moveToFront();this.setConstraint();return;}else{if(this.selectedStencils[obj.id]){console.log("    clicked on selected");var mx=this.group.getTransform();this._offx=obj.x-mx.dx;this._offy=obj.y-mx.dy;return;}else{if(!this.keys.meta){console.log("    deselect all");this.deselect();}else{}}}console.log("    add stencil to selection");this.selectItem(obj.id);var mx=this.group.getTransform();this._offx=obj.x-mx.dx;this._offy=obj.y-mx.dx;this.orgx=obj.x;this.orgy=obj.y;this._isBusy=false;this.undo.add({before:function(){},after:function(){}});},onStencilUp:function(obj){},onStencilDrag:function(obj){if(!this._dragBegun){this.onBeginDrag(obj);this._dragBegun=true;}else{this.saveThrottledState();var x=obj.x-obj.last.x,y=obj.y-obj.last.y,mx=this.group.getTransform(),c=this.constrain,mz=this.defaults.anchors.marginZero;x=obj.x-this._offx;y=obj.y-this._offy;if(x<c.l+mz){x=c.l+mz;}if(y<c.t+mz){y=c.t+mz;}this.group.setTransform({dx:x,dy:y});}},onDragEnd:function(obj){this._dragBegun=false;},onBeginDrag:function(obj){this._wasDragged=true;},onDown:function(obj){this.deselect();},onStencilOver:function(obj){_4.style(obj.id,"cursor","move");},onStencilOut:function(obj){_4.style(obj.id,"cursor","crosshair");},exporter:function(){var _17=[];for(var m in this.stencils){this.stencils[m].enabled&&_17.push(this.stencils[m].exporter());}return _17;},listStencils:function(){return this.stencils;},toSelected:function(_18){var _19=Array.prototype.slice.call(arguments).splice(1);for(var m in this.selectedStencils){var _1a=this.selectedStencils[m];_1a[_18].apply(_1a,_19);}},withSelected:function(_1b){var f=_4.hitch(this,_1b);for(var m in this.selectedStencils){f(this.selectedStencils[m]);}},withUnselected:function(_1c){var f=_4.hitch(this,_1c);for(var m in this.stencils){!this.stencils[m].selected&&f(this.stencils[m]);}},withStencils:function(_1d){var f=_4.hitch(this,_1d);for(var m in this.stencils){f(this.stencils[m]);}},hasSelected:function(){var ln=0;for(var m in this.selectedStencils){ln++;}return ln;},isSelected:function(_1e){return !!this.selectedStencils[_1e.id];}});})();}}};});