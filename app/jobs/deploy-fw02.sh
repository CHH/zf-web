#!/bin/sh

# Ensure we're on fw02
if [ `hostname` != "fw02" ];then
    echo "This script should only be run on fw02"
    exit 1
fi

# Check for root
if [ ! $( id -u ) -eq 0 ]; then
    echo "You must be root to run this script"
    exit 1
fi

# Check for tag in arguments
if [ $# -lt 1 ];then
    echo "Usage: `basename $0` <package> [--patch]"
    echo "<package>  Name of a website package file as generated by package.php"
    echo "--patch    Deploy a patch release (don't rebuild Atlasian indexes)"
    exit 1
fi

# Set some variables
PACKAGE=$1
PHP=$(which php)
if [ "$PHP" = "" ];then
    PHP="/usr/local/bin/php"
fi

FULLDEPLOY=1
if [ $# -ge 2 ];then
    if [ $2 == "--patch" ];then
        FULLDEPLOY=0
    fi
fi

# Extract package
cd /var/www
if [ !-f $PACKAGE ];then
    echo "$PACKAGE is not a package file!"
    exit 42;
fi

echo "Extracting $PACKAGE";
tar xzvf $PACKAGE

RELEASE_DIR=$(basename $PACKAGE .tar.gz)

echo "Pre-seeding ZF2 Kanban board"
(cd $RELEASE_DIR/app/jobs ; $PHP agilezen.php 33552 ../cache/agilezen/agilezen.zf2 )

echo "Compiling ZF2 blog"
(cd $RELEASE_DIR/app/modules/zf2/scripts ; $PHP compile.php)

echo "Pre-seeding contributors list"
(cd $RELEASE_DIR/app/jobs ; $PHP generateContributorsList.php)

# Fetching manual images into tree
(cd $RELEASE_DIR/app/jobs ; $PHP fetchManualImages.php)

echo "Setting ownership on new release directory";
chown -R www.www $RELEASE_DIR

echo "DONE!"
echo "Release is staged to $RELEASE_DIR; test and then, as user www:"
echo "    cd /var/www && rm website && ln -s $RELEASE_DIR website"
